<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>صفحة اختبار المحفظة - Wallet.js</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: #05070b;
      color: #ffffff;
      display: flex;
      justify-content: center;
    }
    .page {
      width: 100%;
      max-width: 520px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: #05070b;
    }
    header {
      height: 52px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 15px;
      font-weight: 600;
    }
    main {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card {
      border-radius: 14px;
      background: #10151d;
      padding: 14px 14px 12px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .card-title {
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .card-sub {
      font-size: 11px;
      color: rgba(255,255,255,0.65);
      margin-bottom: 10px;
    }
    .field-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .field-label {
      color: rgba(255,255,255,0.7);
    }
    .field-value {
      font-weight: 500;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 7px 13px;
      font-size: 12px;
      cursor: pointer;
      background-image: linear-gradient(90deg, #00d1ff, #46EEAC);
      color: #05070b;
      font-weight: 600;
      white-space: nowrap;
    }
    button.secondary {
      background: transparent;
      border: 1px solid #00d1ff;
      color: #00d1ff;
      font-weight: 500;
    }
    .nav-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }
    .nav-link {
      border-radius: 10px;
      background: #0b1017;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px 11px;
      font-size: 12px;
      text-decoration: none;
      color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .nav-link span {
      display: block;
      font-size: 10px;
      color: rgba(255,255,255,0.65);
      margin-top: 2px;
    }
    .arrow {
      width: 8px;
      height: 8px;
      border-right: 2px solid rgba(255,255,255,0.75);
      border-top: 2px solid rgba(255,255,255,0.75);
      transform: rotate(45deg);
    }
    .log-box {
      margin-top: 8px;
      max-height: 120px;
      overflow-y: auto;
      font-size: 11px;
      background: #05070b;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 8px;
      direction: ltr;
      text-align: left;
      white-space: pre-wrap;
    }
    .footer {
      font-size: 11px;
      color: rgba(255,255,255,0.55);
      text-align: center;
      padding: 8px 16px 16px;
      line-height: 1.5;
    }
    .badge-ok {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(70,238,172,0.12);
      border: 1px solid rgba(70,238,172,0.8);
      font-size: 10px;
      color: #46EEAC;
      margin-inline-start: 6px;
    }
    .badge-error {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(255,85,85,0.12);
      border: 1px solid rgba(255,120,120,0.9);
      font-size: 10px;
      color: #ff8080;
      margin-inline-start: 6px;
    }
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: currentColor;
    }
    input[type="number"] {
      width: 90px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      padding: 4px 8px;
      background: transparent;
      color: #ffffff;
      font-size: 11px;
      direction: ltr;
      text-align: left;
    }
    input[type="number"]::placeholder {
      color: rgba(255,255,255,0.4);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      صفحة اختبار المحفظة (wallet.js)
    </header>
    <main>
      <section class="card">
        <div class="card-title">
          حالة الربط مع <code>DemoWallet</code>
          <span id="statusChip" class="badge-error">
            <span class="status-dot"></span> لم يتم الفحص بعد
          </span>
        </div>
        <div class="card-sub">
          هنا نختبر أن كل الدوال الأساسية في <code>wallet.js</code> تعمل بشكل صحيح قبل ما نعتمد الصفحات الحقيقية.
        </div>
        <div class="field-row">
          <span class="field-label">الرصيد الحالي:</span>
          <span class="field-value" id="balanceVal">--</span>
        </div>
        <div class="field-row">
          <span class="field-label">إجمالي الدخل الشخصي:</span>
          <span class="field-value" id="personalIncomeVal">--</span>
        </div>
        <div class="field-row">
          <span class="field-label">إجمالي دخل الفريق:</span>
          <span class="field-value" id="teamIncomeVal">--</span>
        </div>
        <div class="btn-row">
          <button id="refreshBtn">تحديث القيم من DemoWallet</button>
          <button class="secondary" id="resetBtn">إعادة ضبط المحفظة (مسح التخزين المحلي)</button>
        </div>
      </section>

      <section class="card">
        <div class="card-title">اختبار الدخل و السحب</div>
        <div class="card-sub">جرّب إضافة دخل أو تنفيذ سحب، ثم راقب التغيرات في الرصيد والسجّل.</div>
        <div class="btn-row">
          <button id="add10Btn">إضافة دخل +10 USDT</button>
          <button id="add50Btn">إضافة دخل +50 USDT</button>
        </div>
        <div class="btn-row" style="margin-top:10px;">
          <input type="number" id="customAmount" placeholder="قيمة مخصصة" step="0.01" />
          <button class="secondary" id="withdrawBtn">سحب القيمة المخصصة</button>
        </div>
        <div class="log-box" id="logBox"></div>
      </section>

      <section class="card">
        <div class="card-title">اختبار VIP و الفريق</div>
        <div class="card-sub">هنا نفحص أن دوال مستوى العضوية و بيانات الفريق ترجع قيم بدون أخطاء.</div>

        <div class="field-row">
          <span class="field-label">مستوى VIP:</span>
          <span class="field-value" id="vipLevelVal">--</span>
        </div>
        <div class="field-row">
          <span class="field-label">السقف اليومي (USDT):</span>
          <span class="field-value" id="vipDailyLimitVal">--</span>
        </div>
        <div class="field-row">
          <span class="field-label">عدد أعضاء الفريق:</span>
          <span class="field-value" id="teamCountVal">--</span>
        </div>
        <div class="field-row">
          <span class="field-label">إجمالي أرباح الفريق:</span>
          <span class="field-value" id="teamTotalVal">--</span>
        </div>

        <div class="btn-row">
          <button id="vipBtn">تحديث معلومات VIP</button>
          <button class="secondary" id="teamBtn">تحديث معلومات الفريق</button>
        </div>
      </section>

      <section class="card">
        <div class="card-title">روابط الصفحات الفعلية</div>
        <div class="card-sub">بعد ما تتأكد أن كل شيء شغال هنا، جرّب نفس الحالة على الصفحات الحقيقية أدناه.</div>
        <div class="nav-grid">
          <a class="nav-link" href="deposit.html">
            <div>صفحة الإيداع<span>عرض QR وعنوان المحفظة</span></div>
            <div class="arrow"></div>
          </a>
          <a class="nav-link" href="withdraw.html">
            <div>صفحة السحب<span>اختبار لوجيك السحب</span></div>
            <div class="arrow"></div>
          </a>
          <a class="nav-link" href="ai-power.html">
            <div>صفحة AI Power<span>اختبار تنفيذ المهام والدخل</span></div>
            <div class="arrow"></div>
          </a>
          <a class="nav-link" href="member.html">
            <div>صفحة العضوية<span>عرض المستويات والامتيازات</span></div>
            <div class="arrow"></div>
          </a>
          <a class="nav-link" href="my-team.html">
            <div>صفحة فريقي<span>عرض بيانات الفريق</span></div>
            <div class="arrow"></div>
          </a>
        </div>
      </section>
    </main>

    <div class="footer">
      إذا ظهرت كل القيم بشكل صحيح بدون أخطاء في الأعلى وفي السجل، فهذا يعني أن الربط بين الصفحات وملف
      <code>wallet.js</code> سليم ويمكن الاعتماد عليه في المشروع الحقيقي.
    </div>
  </div>

  <script src="wallet.js"></script>
  <script>
    (function () {
      var statusChip = document.getElementById("statusChip");
      var balanceEl = document.getElementById("balanceVal");
      var personalIncomeEl = document.getElementById("personalIncomeVal");
      var teamIncomeEl = document.getElementById("teamIncomeVal");

      var vipLevelEl = document.getElementById("vipLevelVal");
      var vipDailyLimitEl = document.getElementById("vipDailyLimitVal");
      var teamCountEl = document.getElementById("teamCountVal");
      var teamTotalEl = document.getElementById("teamTotalVal");

      var logBox = document.getElementById("logBox");

      var refreshBtn = document.getElementById("refreshBtn");
      var resetBtn = document.getElementById("resetBtn");
      var add10Btn = document.getElementById("add10Btn");
      var add50Btn = document.getElementById("add50Btn");
      var customAmountInput = document.getElementById("customAmount");
      var withdrawBtn = document.getElementById("withdrawBtn");
      var vipBtn = document.getElementById("vipBtn");
      var teamBtn = document.getElementById("teamBtn");

      var STORAGE_KEY = "demoWalletState_v1";

      function log(msg) {
        var time = new Date().toLocaleTimeString();
        logBox.textContent = "[" + time + "] " + msg + "\n" + logBox.textContent;
      }

      function setStatus(ok, text) {
        if (!statusChip) return;
        statusChip.textContent = "";
        statusChip.className = ok ? "badge-ok" : "badge-error";

        var dot = document.createElement("span");
        dot.className = "status-dot";
        statusChip.appendChild(dot);

        var span = document.createElement("span");
        span.textContent = text;
        statusChip.appendChild(span);
      }

      function refreshWalletView() {
        try {
          if (!window.DemoWallet || typeof window.DemoWallet.getWallet !== "function") {
            setStatus(false, "DemoWallet غير معرّف");
            balanceEl.textContent = personalIncomeEl.textContent = teamIncomeEl.textContent = "--";
            return;
          }
          var w = window.DemoWallet.getWallet();
          setStatus(true, "الربط سليم و DemoWallet متوفر");

          var balance = (w.balance || 0);
          var personalIncome = (w.totalIncome || 0);
          var teamIncome = (w.totalTeamIncome || 0);

          balanceEl.textContent = balance.toFixed(2) + " USDT";
          personalIncomeEl.textContent = personalIncome.toFixed(2) + " USDT";
          teamIncomeEl.textContent = teamIncome.toFixed(2) + " USDT";

          log("تم التحديث من getWallet(): balance=" + balance.toFixed(2) +
              ", totalIncome=" + personalIncome.toFixed(2) +
              ", totalTeamIncome=" + teamIncome.toFixed(2));
        } catch (e) {
          console.error(e);
          setStatus(false, "حدث خطأ أثناء قراءة المحفظة");
          log("خطأ في refreshWalletView: " + e.message);
        }
      }

      function resetWallet() {
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch (e) {
          console.warn("LocalStorage remove error", e);
        }
        if (window.DemoWallet && typeof window.DemoWallet.getWallet === "function") {
          window.DemoWallet.getWallet(); // re-init
        }
        log("تم مسح الحالة من localStorage وإعادة تهيئة المحفظة.");
        refreshWalletView();
      }

      function addIncome(amount) {
        if (!window.DemoWallet || typeof window.DemoWallet.addIncome !== "function") {
          alert("DemoWallet.addIncome غير متوفرة.");
          return;
        }
        window.DemoWallet.addIncome(amount);
        log("تم استدعاء addIncome(" + amount + ").");
        refreshWalletView();
      }

      function withdraw(amount) {
        if (!window.DemoWallet || typeof window.DemoWallet.withdraw !== "function") {
          alert("DemoWallet.withdraw غير متوفرة.");
          return;
        }
        try {
          var ok = window.DemoWallet.withdraw(amount);
          if (ok === false) {
            log("فشل السحب: لا يوجد رصيد كافي أو تم رفض العملية.");
            alert("فشل السحب. تأكد من الرصيد وحد السحب.");
          } else {
            log("تم استدعاء withdraw(" + amount + ") بنجاح.");
          }
        } catch (e) {
          log("خطأ أثناء السحب: " + e.message);
          alert("حدث خطأ أثناء السحب. راجع الكونسول.");
        }
        refreshWalletView();
      }

      function updateVipInfo() {
        if (!window.DemoWallet || typeof window.DemoWallet.getVipInfo !== "function") {
          alert("DemoWallet.getVipInfo غير متوفرة.");
          return;
        }
        try {
          var info = window.DemoWallet.getVipInfo();
          vipLevelEl.textContent = info.level != null ? info.level : "--";
          vipDailyLimitEl.textContent = info.dailyLimit != null ? info.dailyLimit + " USDT" : "--";
          log("تم استدعاء getVipInfo(). level=" + info.level + ", dailyLimit=" + info.dailyLimit);
        } catch (e) {
          log("خطأ في getVipInfo(): " + e.message);
          alert("حدث خطأ أثناء قراءة معلومات VIP.");
        }
      }

      function updateTeamInfo() {
        if (!window.DemoWallet || typeof window.DemoWallet.getTeamSummary !== "function") {
          alert("DemoWallet.getTeamSummary غير متوفرة.");
          return;
        }
        try {
          var team = window.DemoWallet.getTeamSummary();
          teamCountEl.textContent = team.count != null ? team.count : "--";
          teamTotalEl.textContent = team.total != null ? team.total.toFixed(2) + " USDT" : "--";
          log("تم استدعاء getTeamSummary(). count=" + team.count + ", total=" + team.total);
        } catch (e) {
          log("خطأ في getTeamSummary(): " + e.message);
          alert("حدث خطأ أثناء قراءة بيانات الفريق.");
        }
      }

      if (refreshBtn) refreshBtn.addEventListener("click", refreshWalletView);
      if (resetBtn) resetBtn.addEventListener("click", resetWallet);
      if (add10Btn) add10Btn.addEventListener("click", function () { addIncome(10); });
      if (add50Btn) add50Btn.addEventListener("click", function () { addIncome(50); });
      if (withdrawBtn) withdrawBtn.addEventListener("click", function () {
        var val = parseFloat(customAmountInput.value);
        if (!val || val <= 0) {
          alert("أدخل قيمة صحيحة للسحب.");
          return;
        }
        withdraw(val);
      });
      if (vipBtn) vipBtn.addEventListener("click", updateVipInfo);
      if (teamBtn) teamBtn.addEventListener("click", updateTeamInfo);

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", refreshWalletView);
      } else {
        refreshWalletView();
      }
    })();
  </script>
</body>
</html>
